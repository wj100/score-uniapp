"use strict";const e=require("../../common/vendor.js"),a=require("../../utils/storage.js"),t={data:()=>({players:[],playerA1:"",playerA2:"",playerB1:"",playerB2:"",scoreA:"",scoreB:"",selectedPlayerA1Index:-1,selectedPlayerA2Index:-1,selectedPlayerB1Index:-1,selectedPlayerB2Index:-1,todayMatches:[]}),onLoad(){this.loadData()},onShow(){this.loadTodayMatches()},computed:{selectedPlayers(){return[this.playerA1,this.playerA2,this.playerB1,this.playerB2].filter((e=>e))},availablePlayersA1(){return this.players.filter((e=>!this.selectedPlayers.includes(e)||e===this.playerA1))},availablePlayersA2(){return this.players.filter((e=>!this.selectedPlayers.includes(e)||e===this.playerA2))},availablePlayersB1(){return this.players.filter((e=>!this.selectedPlayers.includes(e)||e===this.playerB1))},availablePlayersB2(){return this.players.filter((e=>!this.selectedPlayers.includes(e)||e===this.playerB2))},canSubmit(){return this.playerA1&&this.playerA2&&this.playerB1&&this.playerB2&&this.playerA1!==this.playerA2&&this.playerB1!==this.playerB2&&4===this.selectedPlayers.length&&4===new Set(this.selectedPlayers).size&&""!==this.scoreA&&""!==this.scoreB&&(parseInt(this.scoreA)>0||parseInt(this.scoreB)>0)}},onLoad(){this.loadData()},onShow(){this.loadTodayMatches()},methods:{async loadData(){try{if(console.log("开始加载队员数据..."),this.players=await a.getPlayers(),console.log("获取到的队员列表:",this.players),0===this.players.length){console.log("队员列表为空，尝试初始化...");const e=await a.initPlayers();console.log("初始化结果:",e),e&&(this.players=await a.getPlayers(),console.log("重新获取队员列表:",this.players))}this.loadTodayMatches()}catch(t){console.error("加载队员数据失败:",t),this.players=["言志","小鲁","建华","汪骏","杭宁"],e.index.showToast({title:"加载失败，使用默认数据",icon:"none"})}},async loadTodayMatches(){const e=await a.getDoubleMatches("today");this.todayMatches=e},onPlayerA1Change(e){this.selectedPlayerA1Index=e.detail.value,this.playerA1=this.availablePlayersA1[e.detail.value],this.updateAvailableIndexes()},onPlayerA2Change(e){this.selectedPlayerA2Index=e.detail.value,this.playerA2=this.availablePlayersA2[e.detail.value],this.updateAvailableIndexes()},onPlayerB1Change(e){this.selectedPlayerB1Index=e.detail.value,this.playerB1=this.availablePlayersB1[e.detail.value],this.updateAvailableIndexes()},onPlayerB2Change(e){this.selectedPlayerB2Index=e.detail.value,this.playerB2=this.availablePlayersB2[e.detail.value],this.updateAvailableIndexes()},updateAvailableIndexes(){this.playerA1&&(this.selectedPlayerA1Index=this.availablePlayersA1.indexOf(this.playerA1)),this.playerA2&&(this.selectedPlayerA2Index=this.availablePlayersA2.indexOf(this.playerA2)),this.playerB1&&(this.selectedPlayerB1Index=this.availablePlayersB1.indexOf(this.playerB1)),this.playerB2&&(this.selectedPlayerB2Index=this.availablePlayersB2.indexOf(this.playerB2))},onScoreAInput(e){this.scoreA=e.detail.value},onScoreBInput(e){this.scoreB=e.detail.value},async submitScore(){if(this.canSubmit){e.index.showLoading({title:"提交中..."});try{const t={teamA:[this.playerA1,this.playerA2],teamB:[this.playerB1,this.playerB2],scoreA:parseInt(this.scoreA),scoreB:parseInt(this.scoreB)};await a.saveDoubleMatch(t)?(e.index.showToast({title:"提交成功",icon:"success"}),this.resetForm(),this.loadTodayMatches()):e.index.showToast({title:"提交失败",icon:"error"})}catch(t){console.error("提交失败:",t),e.index.showToast({title:"提交失败",icon:"error"})}finally{e.index.hideLoading()}}},resetForm(){this.playerA1="",this.playerA2="",this.playerB1="",this.playerB2="",this.scoreA="",this.scoreB="",this.selectedPlayerA1Index=-1,this.selectedPlayerA2Index=-1,this.selectedPlayerB1Index=-1,this.selectedPlayerB2Index=-1},async deleteMatch(a){console.log("要删除的match对象:",a),console.log("match.id:",a.id),console.log("match._id:",a._id);if(await new Promise((t=>{e.index.showModal({title:"确认删除",content:`确定要删除 ${a.teamA.join("&")} vs ${a.teamB.join("&")} 的双打比赛记录吗？`,success:e=>{t(e.confirm)},fail:()=>{t(!1)}})}))){e.index.showLoading({title:"删除中..."});try{0===(await e.tr.callFunction({name:"badminton-api",data:{action:"deleteDoubleMatch",data:{match_id:a._id||a.id}}})).result.code?(e.index.showToast({title:"删除成功",icon:"success"}),this.loadTodayMatches()):e.index.showToast({title:"删除失败",icon:"error"})}catch(t){console.error("删除失败:",t),e.index.showToast({title:"删除失败",icon:"error"})}finally{e.index.hideLoading()}}}}};const l=e._export_sfc(t,[["render",function(a,t,l,s,i,r){return e.e({a:e.t(i.playerA1||"选择队员1"),b:a.middleIndexA1,c:r.availablePlayersA1,d:e.o(((...e)=>r.onPlayerA1Change&&r.onPlayerA1Change(...e))),e:e.t(i.playerA2||"选择队员2"),f:a.middleIndexA2,g:r.availablePlayersA2,h:e.o(((...e)=>r.onPlayerA2Change&&r.onPlayerA2Change(...e))),i:e.t(i.playerB1||"选择队员3"),j:a.middleIndexB1,k:r.availablePlayersB1,l:e.o(((...e)=>r.onPlayerB1Change&&r.onPlayerB1Change(...e))),m:e.t(i.playerB2||"选择队员4"),n:a.middleIndexB2,o:r.availablePlayersB2,p:e.o(((...e)=>r.onPlayerB2Change&&r.onPlayerB2Change(...e))),q:e.o([e=>i.scoreA=e.detail.value,(...e)=>r.onScoreAInput&&r.onScoreAInput(...e)]),r:i.scoreA,s:e.o([e=>i.scoreB=e.detail.value,(...e)=>r.onScoreBInput&&r.onScoreBInput(...e)]),t:i.scoreB,v:r.canSubmit?"":1,w:e.o(((...e)=>r.submitScore&&r.submitScore(...e))),x:!r.canSubmit,y:0===i.todayMatches.length},0===i.todayMatches.length?{}:{z:e.f(i.todayMatches,((a,t,l)=>({a:e.t(a.teamA.join("&")),b:e.t(a.teamB.join("&")),c:e.t(a.scoreA),d:e.t(a.scoreB),e:e.o((e=>r.deleteMatch(a)),a.id),f:a.id})))})}],["__scopeId","data-v-891a1755"]]);wx.createPage(l);
