"use strict";const e=require("../../common/vendor.js"),a=require("../../utils/storage.js"),t={data:()=>({players:[],player1:"",player2:"",score1:"",score2:"",selectedPlayer1Index:0,selectedPlayer2Index:0,todayMatches:[],showPlayerModal:!1,modalPlayerList:[],selectingPlayer:"",selectedModalPlayer:""}),computed:{availablePlayers1(){return this.players.filter((e=>e!==this.player2))},availablePlayers2(){return this.players.filter((e=>e!==this.player1))},middleIndex1(){const e=this.availablePlayers1.length;return e>0?Math.floor(e/2):0},middleIndex2(){const e=this.availablePlayers2.length;return e>0?Math.floor(e/2):0},canSubmit(){return this.player1&&this.player2&&this.player1!==this.player2&&""!==this.score1&&""!==this.score2&&(parseInt(this.score1)>0||parseInt(this.score2)>0)}},onLoad(){this.loadData()},onShow(){this.loadTodayMatches()},methods:{async loadData(){try{if(console.log("开始加载队员数据..."),this.players=await a.getPlayers(),console.log("获取到的队员列表:",this.players),0===this.players.length){console.log("队员列表为空，尝试初始化..."),e.index.showLoading({title:"正在初始化数据..."});const t=await a.initPlayers();console.log("初始化结果:",t),e.index.hideLoading(),t?(this.players=await a.getPlayers(),console.log("重新获取队员列表:",this.players),e.index.showToast({title:"数据初始化成功",icon:"success"})):(this.players=["言志","小鲁","建华","汪骏","杭宁"],e.index.showToast({title:"网络异常，使用离线数据",icon:"none",duration:3e3}))}this.loadTodayMatches()}catch(t){console.error("加载队员数据失败:",t),this.players=["言志","小鲁","建华","汪骏","杭宁"],e.index.showToast({title:"网络异常，使用离线数据",icon:"none",duration:3e3})}},async loadTodayMatches(){const e=await a.getSingleMatches("today");this.todayMatches=e},onPlayer1Change(e){this.selectedPlayer1Index=e.detail.value,this.player1=this.availablePlayers1[e.detail.value],this.adjustPlayer2Index()},onPlayer2Change(e){this.selectedPlayer2Index=e.detail.value,this.player2=this.availablePlayers2[e.detail.value],this.adjustPlayer1Index()},adjustPlayer1Index(){this.player1&&(this.selectedPlayer1Index=this.availablePlayers1.indexOf(this.player1))},adjustPlayer2Index(){this.player2&&(this.selectedPlayer2Index=this.availablePlayers2.indexOf(this.player2))},onScore1Input(e){this.score1=e.detail.value},onScore2Input(e){this.score2=e.detail.value},async submitScore(){if(this.canSubmit){e.index.showLoading({title:"提交中..."});try{const t={player1:this.player1,player2:this.player2,score1:parseInt(this.score1),score2:parseInt(this.score2)};await a.saveSingleMatch(t)?(e.index.showToast({title:"提交成功",icon:"success"}),this.resetForm(),this.loadTodayMatches()):e.index.showToast({title:"提交失败",icon:"error"})}catch(t){console.error("提交失败:",t),e.index.showToast({title:"提交失败",icon:"error"})}finally{e.index.hideLoading()}}},resetForm(){this.player1="",this.player2="",this.score1="",this.score2="",this.selectedPlayer1Index=-1,this.selectedPlayer2Index=-1},showPlayerSelector(e){this.selectingPlayer=e,this.modalPlayerList="player1"===e?this.availablePlayers1:this.availablePlayers2,this.showPlayerModal=!0},selectPlayer(e){this.selectedModalPlayer=e},confirmPlayer(){this.selectedModalPlayer&&("player1"===this.selectingPlayer?(this.player1=this.selectedModalPlayer,this.adjustPlayer1Index()):(this.player2=this.selectedModalPlayer,this.adjustPlayer2Index())),this.closePlayerModal()},closePlayerModal(){this.showPlayerModal=!1,this.selectedModalPlayer="",this.selectingPlayer=""},async deleteMatch(a){if(await new Promise((t=>{e.index.showModal({title:"确认删除",content:`确定要删除 ${a.player1} vs ${a.player2} 的比赛记录吗？`,success:e=>{t(e.confirm)},fail:()=>{t(!1)}})}))){e.index.showLoading({title:"删除中..."});try{0===(await e.tr.callFunction({name:"badminton-api",data:{action:"deleteSingleMatch",data:{match_id:a._id||a.id}}})).result.code?(e.index.showToast({title:"删除成功",icon:"success"}),this.loadTodayMatches()):e.index.showToast({title:"删除失败",icon:"error"})}catch(t){console.error("删除失败:",t),e.index.showToast({title:"删除失败",icon:"error"})}finally{e.index.hideLoading()}}}}};const l=e._export_sfc(t,[["render",function(a,t,l,s,o,r){return e.e({a:e.t(o.player1||"选择队员1"),b:r.middleIndex1,c:r.availablePlayers1,d:e.o(((...e)=>r.onPlayer1Change&&r.onPlayer1Change(...e))),e:e.t(o.player2||"选择队员2"),f:r.middleIndex2,g:r.availablePlayers2,h:e.o(((...e)=>r.onPlayer2Change&&r.onPlayer2Change(...e))),i:e.t(o.player1||"队员1"),j:e.o([e=>o.score1=e.detail.value,(...e)=>r.onScore1Input&&r.onScore1Input(...e)]),k:o.score1,l:e.t(o.player2||"队员2"),m:e.o([e=>o.score2=e.detail.value,(...e)=>r.onScore2Input&&r.onScore2Input(...e)]),n:o.score2,o:r.canSubmit?"":1,p:e.o(((...e)=>r.submitScore&&r.submitScore(...e))),q:!r.canSubmit,r:0===o.todayMatches.length},0===o.todayMatches.length?{}:{s:e.f(o.todayMatches,((a,t,l)=>({a:e.t(a.player1),b:e.t(a.player2),c:e.t(a.score1),d:e.t(a.score2),e:e.o((e=>r.deleteMatch(a)),a.id),f:a.id})))},{t:o.showPlayerModal},o.showPlayerModal?{v:e.f(o.modalPlayerList,((a,t,l)=>({a:e.t(a),b:t,c:e.o((e=>r.selectPlayer(a)),t)}))),w:e.o(((...e)=>r.closePlayerModal&&r.closePlayerModal(...e))),x:e.o(((...e)=>r.confirmPlayer&&r.confirmPlayer(...e))),y:e.o((()=>{})),z:e.o(((...e)=>r.closePlayerModal&&r.closePlayerModal(...e)))}:{})}],["__scopeId","data-v-1cb279bc"]]);wx.createPage(l);
