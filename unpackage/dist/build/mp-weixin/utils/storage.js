"use strict";const t=require("../common/vendor.js");exports.getDoubleMatches=async function(e="all"){try{const a=await t.tr.callFunction({name:"badminton-api",data:{action:"getDoubleMatches",data:{timeRange:e}}});return 0===a.result.code?a.result.data:(console.error("获取双打比赛记录失败:",a.result.message),[])}catch(a){return console.error("获取双打比赛记录异常:",a),[]}},exports.getDoubleStats=async function(e="all"){try{const a=await t.tr.callFunction({name:"badminton-api",data:{action:"getDoubleStats",data:{timeRange:e}}});return 0===a.result.code?a.result.data:(console.error("获取双打统计数据失败:",a.result.message),{stats:{},matches:[]})}catch(a){return console.error("获取双打统计数据异常:",a),{stats:{},matches:[]}}},exports.getPlayers=async function(){let e=null;for(let n=0;n<3;n++)try{console.log(`调用云函数获取队员列表... (第${n+1}次尝试)`);const a=await t.tr.callFunction({name:"badminton-api",data:{action:"getPlayers"}});if(console.log("云函数返回结果:",a),0===a.result.code){const t=a.result.data.map((t=>t.name));return console.log("解析后的队员列表:",t),t}if(console.error("获取队员列表失败:",a.result.message),e=new Error(a.result.message),a.result.message&&a.result.message.includes("资源耗尽")&&n<2){console.log(`数据库资源耗尽，等待 ${2*(n+1)} 秒后重试...`),await new Promise((t=>setTimeout(t,2e3*(n+1))));continue}return["言志","小鲁","建华","汪骏","杭宁"]}catch(a){console.error(`获取队员列表异常 (第${n+1}次尝试):`,a),e=a,n<2&&(console.log(`等待 ${2*(n+1)} 秒后重试...`),await new Promise((t=>setTimeout(t,2e3*(n+1)))))}return console.error("所有重试都失败，使用降级数据"),t.index.showToast({title:"网络异常，使用离线数据",icon:"none",duration:3e3}),["言志","小鲁","建华","汪骏","杭宁"]},exports.getSingleMatchAnalysis=async function(e){try{const a=await t.tr.callFunction({name:"badminton-api",data:{action:"getSingleMatchAnalysis",data:e}});return 0===a.result.code?a.result.data:(console.error("获取单打分析数据失败:",a.result.message),{stats:{},matches:[]})}catch(a){return console.error("获取单打分析数据异常:",a),{stats:{},matches:[]}}},exports.getSingleMatches=async function(e="all"){try{const a=await t.tr.callFunction({name:"badminton-api",data:{action:"getSingleMatches",data:{timeRange:e}}});return 0===a.result.code?a.result.data:(console.error("获取单打比赛记录失败:",a.result.message),[])}catch(a){return console.error("获取单打比赛记录异常:",a),[]}},exports.getSingleStats=async function(e="all"){try{const a=await t.tr.callFunction({name:"badminton-api",data:{action:"getSingleStats",data:{timeRange:e}}});return 0===a.result.code?a.result.data:(console.error("获取单打统计数据失败:",a.result.message),{stats:{},matches:[]})}catch(a){return console.error("获取单打统计数据异常:",a),{stats:{},matches:[]}}},exports.initPlayers=async function(){for(let a=0;a<2;a++)try{console.log(`初始化队员... (第${a+1}次尝试)`);const e=await t.tr.callFunction({name:"badminton-api",data:{action:"initPlayers"}});if(console.log("初始化队员结果:",e),0===e.result.code)return!0;if(console.error("初始化队员失败:",e.result.message),e.result.message&&e.result.message.includes("资源耗尽")&&a<1){console.log(`数据库资源耗尽，等待 ${3*(a+1)} 秒后重试...`),await new Promise((t=>setTimeout(t,3e3*(a+1))));continue}return!1}catch(e){console.error(`初始化队员异常 (第${a+1}次尝试):`,e),a<1&&(console.log(`等待 ${3*(a+1)} 秒后重试...`),await new Promise((t=>setTimeout(t,3e3*(a+1)))))}return console.error("初始化队员失败，所有重试都失败"),!1},exports.saveDoubleMatch=async function(e){try{const a=await t.tr.callFunction({name:"badminton-api",data:{action:"submitDoubleMatch",data:e}});return 0===a.result.code?{id:a.result.data.match_id,...e}:(console.error("保存双打比赛记录失败:",a.result.message),null)}catch(a){return console.error("保存双打比赛记录异常:",a),null}},exports.saveSingleMatch=async function(e){try{const a=await t.tr.callFunction({name:"badminton-api",data:{action:"submitSingleMatch",data:e}});return 0===a.result.code?{id:a.result.data.match_id,...e}:(console.error("保存单打比赛记录失败:",a.result.message),null)}catch(a){return console.error("保存单打比赛记录异常:",a),null}};
